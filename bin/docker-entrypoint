#!/bin/bash -e

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  # Validate that required environment variables are provided
  MISSING_VARS=()

  if [ -z "$ADMIN_EMAIL" ]; then
    MISSING_VARS+=("ADMIN_EMAIL")
  fi

  if [ -z "$ADMIN_PASSWORD" ]; then
    MISSING_VARS+=("ADMIN_PASSWORD")
  fi

  if [ -z "$APP_HOST" ] && [ -z "$RENDER_EXTERNAL_URL" ]; then
    MISSING_VARS+=("APP_HOST")
  fi

  if [ ${#MISSING_VARS[@]} -gt 0 ]; then
    echo "ERROR: Required environment variables are missing: ${MISSING_VARS[*]}"
    echo ""
    echo "Required variables:"
    echo "  - ADMIN_EMAIL: Email for the admin user"
    echo "  - ADMIN_PASSWORD: Secure password for the admin user"
    echo "  - APP_HOST: Your application domain (e.g., mystore.com)"
    echo ""
    echo "Example:"
    echo "  docker run -e ADMIN_EMAIL=admin@mystore.com \\"
    echo "             -e ADMIN_PASSWORD=securepassword \\"
    echo "             -e APP_HOST=mystore.com \\"
    echo "             your-image"
    exit 1
  fi

  # Display admin credentials being used (for debugging)
  echo "===================================="
  echo "Setting up database..."
  echo "Admin credentials:"
  echo "  Email: $ADMIN_EMAIL"
  echo "  Password: [hidden]"
  echo "===================================="

  # Run database migrations
  ./bin/rails db:migrate

  # Always run seed to ensure admin user is created/updated
  # This runs on every deployment, not just first time
  echo "Running database seed..."
  ./bin/rails db:seed

  echo "===================================="
  echo "Database setup complete!"
  echo "===================================="
fi

exec "${@}"
